# 里程碑计划文档规范（模板）

> 适用范围：`doc/milestone/` 下的里程碑计划文档

## 1. 目标与原则

- 一个里程碑只解决一类核心问题，避免”全栈大杂烩”。
- 写”可交付结果”和”可验证标准”，不写泛泛描述。
- 先定义边界（范围/非目标），再写方案细节。
- 每个关键承诺都要能在”测试与验收 + DoD”中落地验证。
- 单元测试必须严格覆盖所有可达测试路径；未覆盖路径必须给出不可达证明。
- 问题修复类里程碑必须采用 TDD（Red-Green-Refactor）：先写失败测试锁定缺陷，再写最小修复使测试通过，最后重构。
- **内容深度原则**：每个章节必须达到”另一位开发者仅凭本文档即可完成实现”的信息密度。纯文字描述不足以替代代码片段、流程图、数据结构定义等具象化表达。

## 2. 统一主模板（必填）

所有里程碑默认使用以下主模板；仅在“实现步骤/实现方案”命名上按技术栈二选一。

```md
# 里程碑 <N>：<标题>

> **前置条件**: <依赖的里程碑/能力>
> **目标**: <一句话目标（可验证）>

## 1. 目标

<!-- 跨栈里程碑必须先给子系统交付矩阵 -->
### 子系统交付矩阵（涉及两个及以上子系统时必填）

| 子系统 | 交付项 |
|--------|--------|
| <子系统 A> | <该子系统的具体交付物> |
| <子系统 B> | <该子系统的具体交付物> |

- <交付项 1>
- <交付项 2>
<!-- 3-8 条交付项，每条必须可验证 -->

## 2. 背景与问题
- <当前痛点/缺口>
- <为什么必须现在做>

**范围**:
- <本里程碑覆盖的具体边界，逐条列出>

**非目标**:
- <明确不做的事项，逐条列出，避免范围膨胀>

## 3. 技术要点（或技术方案）

<!-- 硬性约束：本章必须包含下列至少两类具象化内容，纯文字描述不达标 -->
<!-- (a) 代码片段：关键数据结构定义、常量声明、API 签名 -->
<!-- (b) 流程图/时序图：ASCII 流程图或状态机，展示核心交互路径 -->
<!-- (c) Before/After 对比：改动前后的代码或行为对比 -->
<!-- (d) 契约表格：API 路径/方法/请求体/响应体/状态码/错误码 -->
<!-- (e) 错误处理策略表：错误场景 → 行为 → 错误码/退出码 -->

### 3.1 <子主题>
- <关键设计决策>
- <接口/协议/数据模型约束>

```cpp / ```js / ```
// 必须给出关键数据结构、常量、API 签名或协议片段
```

### 3.2 <子主题>
- <兼容性与边界条件>
- <生命周期影响>

<!-- 每个独立技术决策点必须拆为一个子节，子节数量与决策点数量一致 -->

### 3.N 向后兼容与边界（涉及已有行为变更或公共 API 改动时必填）
- <无此改动时的行为>
- <有此改动时的行为变更说明>

## 4. 实现步骤（或实现方案）

<!-- 硬性约束：每个改动点必须包含以下三要素，禁止只写"在 X 中新增 Y"一句话 -->
<!-- (1) 涉及的类/函数/文件名 -->
<!-- (2) 方法签名、结构体定义或伪代码（至少给出关键代码片段） -->
<!-- (3) 改动理由与验收方式 -->

### 4.1 <模块/文件 A 的改动>

- 修改 `<path/to/file.h>`：
  - 新增/修改 `<成员/方法名>`
  - 签名或结构体定义：
    ```cpp
    // 关键代码片段（头文件声明、方法签名、结构体字段等）
    ```
- 修改 `<path/to/file.cpp>`：
  - `<方法名>()` 中的改动逻辑：
    ```cpp
    // 伪代码或关键实现片段
    ```

### 4.2 <模块/文件 B 的改动>
<!-- 同上格式，逐文件描述 -->

<!-- 问题修复类里程碑：用以下 TDD 流程替换上方通用格式 -->
## 4. 实现步骤（TDD Red-Green-Refactor）
### 4.1 Red — 编写失败测试
- 缺陷复现条件: <最小输入/状态/时序>
- 失败测试用例:
  - `<test_id>`: <输入> → 期望 <正确行为>，当前实际 <错误行为>
- 断言要点: <错误码/返回值/状态，必须精确到可判定>
- 确认测试在修复前 **必定失败（Red）**
### 4.2 Green — 最小修复实现
- <修复点 1>: <改动描述（仅满足测试通过，不做额外优化）>
- <修复点 N>: ...
- 确认 4.1 中所有失败测试 **全部通过（Green）**
- 确认既有测试套件 **无回归**
### 4.3 Refactor — 重构（修复引入重复代码或破坏既有结构时必须执行，否则写明"无需重构"）
- <消除重复/改善命名/提取公共逻辑>
- 重构后所有测试（新增 + 既有）**仍全部通过**

## 5. 文件变更清单（或文件清单）
### 5.1 新增文件
- `<path>` - <用途>
### 5.2 修改文件
- `<path>` - <用途>
### 5.3 测试文件
- `<path>` - <用途>

## 6. 测试与验收
### 6.1 单元测试（必填，重点）
- 测试对象: <类/函数/模块边界>
- 用例分层: <正常路径>、<边界值>、<异常输入>、<错误传播>、<兼容回归>
- 断言要点: <返回值/状态变更/副作用/错误码与错误信息>
- 桩替身策略: <mock/stub/fake 的对象与行为，说明替代边界>
- 测试文件: `<测试文件路径>`

#### 路径矩阵（必填）

为每个决策点列出全部可达分支，并给出一一对应测试用例 ID。

| 决策点 | 路径 | 用例 ID |
|--------|------|---------|
| `<函数/分支>`: <条件 A> | <行为描述> | T01 |
| `<函数/分支>`: <条件 B> | <行为描述> | T02 |
| ... | 不可达 — <原因与证明> | — |

覆盖要求（硬性）: 所有可达路径 `100%` 有用例；不可达路径需写明原因与证明方式。

#### 用例详情（必填）

<!-- 硬性约束：每条用例必须独立展开为以下结构化段落，禁止仅在路径矩阵表格中一行带过 -->

**T01 — <用例标题>**
- 前置条件: <测试环境/状态准备>
- 输入: <具体调用方式与参数>
- 预期: <期望的返回值/状态变更/副作用>
- 断言: <精确到可判定的断言表达式，含错误码/错误类型>

**T02 — <用例标题>**
- 前置条件: ...
- 输入: ...
- 预期: ...
- 断言: ...

<!-- 逐条展开所有用例，直到 TNN -->

#### 测试代码（必填）

<!-- 必须给出测试代码框架或完整测试代码块 -->
<!-- 使用项目对应的测试框架（如 gtest、Jest、Vitest、pytest 等） -->

```cpp
TEST(<TestSuite>, <T01_TestName>) {
    // 前置准备
    // 执行
    // 断言
}

TEST(<TestSuite>, <T02_TestName>) {
    // ...
}
```

### 6.2 集成/端到端测试（涉及跨模块交互或跨进程通信时必填）
- <跨模块联动>
- <协议/API/进程生命周期联调>
- <关键用户流程 E2E（前端或发布链路）>

### 6.3 验收标准
- [ ] <可执行、可观察、可判定>
<!-- 每条验收标准必须对应至少一个测试用例 ID -->

## 7. 风险与控制
<!-- 硬性约束：每条风险必须给出至少一条具体控制措施，禁止只列风险名词 -->
<!-- 控制措施必须是可执行的（预防/监控/回滚/测试覆盖），不能是"注意一下"这类泛泛描述 -->
- 风险: <风险描述，含触发条件与影响范围>
  - 控制: <预防措施>
  - 控制: <监控/检测手段>
  - 控制: <回滚/降级方案（涉及数据持久化或外部状态变更时必填）>
  - 测试覆盖: <对应的测试用例 ID（风险路径有测试覆盖时必填）>

## 8. 里程碑完成定义（DoD）
- [ ] 代码与测试完成
- [ ] 文档同步完成
- [ ] 向后兼容/迁移策略确认
<!-- 问题修复类里程碑追加以下条件 -->
- [ ] 【问题修复类】Red 阶段失败测试有执行记录
- [ ] 【问题修复类】Green 阶段全量测试通过（新增 + 既有无回归）
- [ ] 【问题修复类】Refactor 阶段（若有）全量测试仍通过
```

## 3. 分技术栈差异化要求

### 3.1 编译型语言核心库/协议层（C/C++/Rust/Go 等）

- `4` 章必须用”实现步骤”（按类/函数拆解）。
- `3` 章必须给出数据结构或协议片段（类型映射/状态机/序列化格式）。
- `6.1` 需覆盖边界与异常路径（类型错误、流式半包、超时、资源释放）。
- 单元测试至少覆盖：序列化/反序列化对称性、非法输入、资源释放、错误码稳定性。
- 依赖其他里程碑时必须包含”依赖关系”章节（放 `8` 后附录）。

### 3.2 脚本语言运行时/绑定层（JS/Python/Lua 绑定等）

- 在 `2` 章前或 `3` 章前增加：
  - `设计原则（强约束）`
  - `范围与非目标`
- 必须写清 API 签名、参数校验、错误语义、生命周期清理。
- 异步能力必须明确 Promise/Future 何时 resolve/reject、资源何时释放。
- `6.1` 需覆盖并发、异常、资源泄漏与兼容行为。
- 单元测试至少覆盖：参数校验分支、异步成败路径、回调顺序、重复释放幂等。

### 3.3 Server/API 层（HTTP 服务、RPC、消息队列等）

- `3` 章必须包含 API 契约：
  - 路径、方法、请求体、响应体、状态码、错误码。
- 写明与既有接口的兼容关系（不破坏已发布行为）。
- 涉及路由时写清静态/动态路由优先级与注册顺序。
- 涉及文件系统时写明安全约束（路径穿越、原子写入、权限边界）。
- 单元测试至少覆盖：handler 正常/异常分支、参数缺失、状态码与错误体一致性、权限/路径安全。

### 3.4 前端 UI 模块（Web/Desktop/Mobile）

- `3` 章必须覆盖页面结构、状态管理、交互流、依赖 API 映射。
- `4` 章必须按”页面/组件/Store/Hook”分块描述。
- `6.1` 至少包含组件测试 + 状态管理测试；关键流程补 E2E。
- 单元测试至少覆盖：状态迁移、组件关键交互、错误态渲染、API mock 分支。
- 涉及视觉系统或复杂交互变更时必须包含 `UI/UX 设计规范` 章节。

### 3.5 发布、迁移、E2E

- `2` 章必须写”发布/迁移边界”和”非目标”。
- `4` 章必须包含流水线或脚本步骤（构建、产物校验、发布）。
- `6.1` 必须覆盖”可复现验证”与”失败回滚”。
- 测试用例需覆盖”脚本失败退出码 + 关键产物校验 + 回滚路径”。

## 3.6 问题修复类里程碑（TDD 强制）

- 里程碑标题或目标中含"修复/fix/bugfix/回归/regression"时，**必须**采用 TDD 流程。
- `4` 章必须使用"TDD Red-Green-Refactor"三段式结构，不得使用通用实现步骤格式。
- `4.1 Red` 阶段要求：
  - 为每个待修复缺陷编写至少一条精确的失败测试，测试必须在修复前运行并确认失败。
  - 失败测试必须断言**正确行为**（而非断言"当前的错误行为"），确保修复后测试自然通过。
  - 若缺陷涉及多个触发路径，每条路径各写一条独立测试。
- `4.2 Green` 阶段要求：
  - 仅做使失败测试通过的最小改动，禁止搭车重构或附加功能。
  - 修复后必须运行完整测试套件，确认无回归。
- `4.3 Refactor` 阶段要求：
  - 仅在修复引入重复代码或破坏既有结构时执行；若无需重构，必须在本节写明"无需重构"及理由。
  - 重构后全量测试必须仍然通过。
- `6.1` 中的回归测试用例必须标注来源缺陷编号或现象描述，便于追溯。
- DoD 额外条件：失败测试在修复前确认为 Red，修复后确认为 Green，有执行记录可查。

## 4. 模板选型路线（先选再写）

1. 以编译型核心库/协议层为主：用”核心库模板”（§3.1）。
2. 以脚本语言绑定/运行时为主：用”绑定层模板”（§3.2）。
3. 以 HTTP/API/RPC 服务为主：用”Server/API 模板”（§3.3）。
4. 以页面交互为主：用”前端 UI 模板”（§3.4）。
5. 以发布/迁移/E2E 为主：用”发布模板”（§3.5）。
6. 跨栈里程碑：主模板不变，但在 `1` 章先给”子系统交付矩阵”。
7. 问题修复/缺陷回归：用”问题修复 TDD 模板”（§3.6），`4` 章强制使用 Red-Green-Refactor 三段式。

## 5. 质量闸门（提交前自检）

### 结构完整性
- [ ] 章节编号唯一、递增、无重复。
- [ ] 存在”前置条件 + 目标 + 范围/非目标”。
- [ ] 范围与非目标各为独立列表，逐条列出，非内联一句话。
- [ ] 存在”文件变更清单 + 测试与验收 + DoD”。
- [ ] 验收标准均可客观判定，避免”体验更好”这类不可验描述。
- [ ] 风险章节每条风险包含具体控制措施（预防/监控/回滚），不是只列风险名词。
- [ ] 术语、字段名、API 名称与现有代码和文档一致。

### 内容深度（硬性）
- [ ] `§3 技术要点` 包含至少两类具象化内容（代码片段/流程图/Before-After 对比/契约表格/错误策略表），纯文字描述不达标。
- [ ] `§3 技术要点` 按独立技术决策点拆分子节（3.1, 3.2, ...），每节聚焦一个主题。
- [ ] `§4 实现步骤` 每个改动点包含三要素：涉及的类/函数名、方法签名或伪代码、改动理由。禁止只写”在 X 中新增 Y”一句话。
- [ ] `§4 实现步骤` 按文件/模块拆分子节（4.1, 4.2, ...），每节给出关键代码片段。
- [ ] `§6 测试` 路径矩阵之外，每条用例有独立详情块（前置条件/输入/预期/断言），禁止仅在表格中一行带过。
- [ ] `§6 测试` 必须给出项目测试框架对应的测试代码框架或完整测试代码块。

### 测试覆盖
- [ ] 单元测试用例按”正常/边界/异常/回归”四类明确列出，不少于核心变更点数量。
- [ ] 每个新增/修改公共 API 都有对应测试，且写明测试文件路径。
- [ ] 失败场景断言包含错误码或错误类型，不只断言”失败了”。
- [ ] 所有可达测试路径均被单元测试覆盖；每条路径可追溯到具体测试用例 ID。
- [ ] 对声明”不可达”的路径提供设计级证明（状态机约束/参数前置条件/防御式分支）。

### 问题修复类（TDD 专项）
- [ ] 【问题修复类】`4` 章使用 TDD Red-Green-Refactor 三段式，非通用实现步骤格式。
- [ ] 【问题修复类】每个缺陷至少有一条失败测试，且标注了缺陷来源（编号/现象）。
- [ ] 【问题修复类】文档中记录了 Red 阶段测试确认失败、Green 阶段测试确认通过的执行证据。

## 6. 测试写作细则（重点：单元测试）

- 按“测试对象 -> 输入 -> 预期输出 -> 关键断言”四段写每类用例，避免只写标题。
- 单元测试优先验证纯逻辑与边界；集成测试只覆盖跨模块协作与契约稳定性。
- 对异步逻辑必须给出“完成条件”和“超时/取消条件”的断言方式。
- 对异常路径必须断言具体错误语义（错误码、错误消息、异常类型三选二）。
- 对回归 bug 必须附“最小复现用例”并在文档中标注来源（问题单/现象描述）。
- 对 mock 使用要说明替代边界，避免把被测逻辑也 mock 掉。
- 测试章节禁止只写“补充单元测试”，必须列出至少 3 条可执行测试场景。
- 必须在文档中维护"决策点 -> 路径 -> 用例 ID"映射表（即路径矩阵），评审时逐条勾验，不允许遗漏路径。
- 【TDD 专项】问题修复类测试必须先于修复代码编写；测试用例断言的是"正确行为"而非"当前错误行为"。
- 【TDD 专项】失败测试（Red）必须附运行输出摘要或截图，证明修复前确实失败。
- 【TDD 专项】禁止在 Green 阶段引入与修复无关的改动；额外改进必须放到 Refactor 阶段并单独说明。

## 7. 写作约束（简洁但不漏重点）

- 目标章节控制在 `3-8` 条交付项。
- 技术要点聚焦”决策与约束”，但必须用代码/图表/表格等具象化手段表达，不能只写文字描述。
- 实现章节聚焦”改哪里、为什么、怎么验收”，每个改动点必须给出方法签名或伪代码片段，但避免逐行代码解释。
- 示例以最小可用片段为主，避免超长代码块；但”没有代码片段”比”代码片段过长”更不可接受。
- 测试章节路径矩阵表为索引，用例详情块为正文，两者缺一不可。
- 文件清单按”新增/修改/测试”三段固定输出，便于评审和执行。
- 风险章节每条风险必须给出可执行的控制措施，禁止”注意一下”式泛泛描述。
