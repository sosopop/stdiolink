# 架构概述

本章介绍 stdiolink 的整体架构设计。

## 分层架构

stdiolink 采用三层架构设计：

```
┌─────────────────────────────────────────────────────┐
│                   应用层 (Application)               │
│         业务逻辑、命令处理器、UI 集成                  │
├─────────────────────────────────────────────────────┤
│              JS Service 运行时 (可选)                 │
│    QuickJS-NG / openDriver / exec / getConfig   │
├─────────────────────────────────────────────────────┤
│                   框架层 (Framework)                 │
│    DriverCore / Driver / Task / MetaBuilder         │
├─────────────────────────────────────────────────────┤
│                   协议层 (Protocol)                  │
│    JSONL Parser / Serializer / MetaTypes            │
└─────────────────────────────────────────────────────┘
```

## 组件关系

### Host 端组件

```
┌─────────────────────────────────────────┐
│              Host Application            │
├─────────────────────────────────────────┤
│  Driver      Driver      Driver         │
│    │           │           │            │
│  Task        Task        Task           │
│    │           │           │            │
│    └───────────┴───────────┘            │
│              waitAnyNext                 │
├─────────────────────────────────────────┤
│           QProcess (stdin/stdout)        │
└─────────────────────────────────────────┘
```

### Driver 端组件

```
┌─────────────────────────────────────────┐
│           ICommandHandler               │
│         (业务逻辑实现)                    │
├─────────────────────────────────────────┤
│             DriverCore                   │
│    ┌──────────┬──────────┐              │
│    │  Stdio   │ Console  │              │
│    │  Mode    │  Mode    │              │
│    └──────────┴──────────┘              │
├─────────────────────────────────────────┤
│  JsonlParser │ IResponder │ MetaValidator│
└─────────────────────────────────────────┘
```

## 数据流

### 请求-响应流程

```
Host                              Driver
  │                                  │
  │  {"cmd":"echo","data":{...}}     │
  │ ────────────────────────────────▶│
  │                                  │ parse request
  │                                  │ validate params
  │                                  │ call handler
  │                                  │
  │  {"status":"event",...,"data":...} │
  │ ◀────────────────────────────────│ (可选的中间事件)
  │                                  │
  │  {"status":"done",...,"data":...}  │
  │ ◀────────────────────────────────│
  │                                  │
```

### 消息状态

| 状态 | 说明 |
|------|------|
| `event` | 中间事件，可能有多个 |
| `done` | 成功完成 |
| `error` | 执行失败 |

## 运行模式

### Stdio 模式

标准的 IPC 模式，通过 stdin/stdout 与 Host 通信：

- Host 通过 QProcess 启动 Driver
- 请求通过 stdin 发送
- 响应通过 stdout 返回

### Console 模式

命令行交互模式，用于调试和独立使用：

- 直接在终端运行 Driver
- 通过命令行参数传递请求
- 结果输出到终端

## 元数据系统

元数据系统是 stdiolink 的核心特性，实现 Driver 的自描述能力。

```
┌─────────────────────────────────────────┐
│              DriverMeta                  │
│  ┌─────────────────────────────────┐    │
│  │           DriverInfo             │    │
│  │  id, name, version, vendor       │    │
│  └─────────────────────────────────┘    │
│  ┌─────────────────────────────────┐    │
│  │         CommandMeta[]            │    │
│  │  ┌───────────────────────────┐  │    │
│  │  │  name, description        │  │    │
│  │  │  params: FieldMeta[]      │  │    │
│  │  │  returns: ReturnMeta      │  │    │
│  │  │  events: EventMeta[]      │  │    │
│  │  └───────────────────────────┘  │    │
│  └─────────────────────────────────┘    │
│  ┌─────────────────────────────────┐    │
│  │          ConfigSchema            │    │
│  │  fields, apply                   │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

## 下一步

- [协议层文档](04-protocol/README.md) - 了解 JSONL 协议细节
- [Driver 端开发](05-driver/README.md) - 开发 Driver 程序
- [Host 端开发](06-host/README.md) - 开发 Host 程序
- [JS Service 运行时](10-js-service/README.md) - 使用 JS 脚本编排 Driver
