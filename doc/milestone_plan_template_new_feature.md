# 里程碑计划文档规范（新需求开发模板）

> 适用范围：`doc/milestone/` 下的里程碑计划文档  
> 归纳来源：里程碑 `01-69` 的结构与内容模式（核心库、JS 运行时、Server/API、WebUI、发布/E2E）
> 适用路线：新需求开发；问题修复请使用 `doc/milestone_plan_template_bugfix.md`

## 1. 目标与原则

- 一个里程碑只解决一类核心问题，避免“全栈大杂烩”。
- 写“可交付结果”和“可验证标准”，不写泛泛描述。
- 先定义边界（范围/非目标），再写方案细节。
- 每个关键承诺都要能在"测试与验收 + DoD"中落地验证。
- 单元测试必须严格覆盖所有可达测试路径；未覆盖路径必须给出不可达证明。
- 问题修复类里程碑必须采用 TDD（Red-Green-Refactor）：先写失败测试锁定缺陷，再写最小修复使测试通过，最后重构。

## 2. 统一主模板（必填）

所有里程碑默认使用以下主模板；仅在“实现步骤/实现方案”命名上按技术栈二选一。

```md
# 里程碑 <N>：<标题>

> **前置条件**: <依赖的里程碑/能力>
> **目标**: <一句话目标（可验证）>

## 1. 目标
- <交付项 1>
- <交付项 2>

## 2. 背景与问题
- <当前痛点/缺口>
- <为什么必须现在做>
- **范围**: <本里程碑覆盖>
- **非目标**: <明确不做，避免范围膨胀>

## 3. 技术要点（或技术方案）
- <关键设计决策>
- <接口/协议/数据模型约束>
- <兼容性与边界条件>

## 4. 实现步骤（或实现方案）
- <模块 A 的改动点>
- <模块 B 的改动点>
- <关键流程/伪代码/时序（按需）>

<!-- 问题修复类里程碑：用以下 TDD 流程替换上方通用格式 -->
## 4. 实现步骤（TDD Red-Green-Refactor）
### 4.1 Red — 编写失败测试
- 缺陷复现条件: <最小输入/状态/时序>
- 失败测试用例:
  - `<test_id>`: <输入> → 期望 <正确行为>，当前实际 <错误行为>
- 断言要点: <错误码/返回值/状态，必须精确到可判定>
- 确认测试在修复前 **必定失败（Red）**
### 4.2 Green — 最小修复实现
- <修复点 1>: <改动描述（仅满足测试通过，不做额外优化）>
- <修复点 N>: ...
- 确认 4.1 中所有失败测试 **全部通过（Green）**
- 确认既有测试套件 **无回归**
### 4.3 Refactor — 重构（按需）
- <消除重复/改善命名/提取公共逻辑>
- 重构后所有测试（新增 + 既有）**仍全部通过**

## 5. 文件变更清单（或文件清单）
### 5.1 新增文件
- `<path>` - <用途>
### 5.2 修改文件
- `<path>` - <用途>
### 5.3 测试文件
- `<path>` - <用途>

## 6. 测试与验收
### 6.1 单元测试（必填，重点）
- 测试对象: <类/函数/模块边界>
- 用例分层: <正常路径>、<边界值>、<异常输入>、<错误传播>、<兼容回归>
- 断言要点: <返回值/状态变更/副作用/错误码与错误信息>
- 桩替身策略: <mock/stub/fake 的对象与行为>
- 测试文件: `<src/tests/test_xxx.cpp>` 或 `<src/webui/src/**/__tests__/*.test.ts>`
- 路径矩阵（必填）: 为每个决策点列出全部可达分支，并给出一一对应测试用例 ID
- 覆盖要求（硬性）: 所有可达路径 `100%` 有用例；不可达路径需写明原因与证明方式
### 6.2 集成/端到端测试（按需）
- <跨模块联动>
- <协议/API/进程生命周期联调>
- <关键用户流程 E2E（前端或发布链路）>
### 6.3 验收标准
- [ ] <可执行、可观察、可判定>

## 7. 风险与控制
- 风险: <风险描述>
  - 控制: <预防/监控/回滚措施>

## 8. 里程碑完成定义（DoD）
- [ ] 代码与测试完成
- [ ] 文档同步完成
- [ ] 向后兼容/迁移策略确认
<!-- 问题修复类里程碑追加以下条件 -->
- [ ] 【问题修复类】Red 阶段失败测试有执行记录
- [ ] 【问题修复类】Green 阶段全量测试通过（新增 + 既有无回归）
- [ ] 【问题修复类】Refactor 阶段（若有）全量测试仍通过
```

## 3. 分技术栈差异化要求

## 3.1 C++ 核心库/协议/Host-Driver（典型：M01-M20）

- `4` 章优先用“实现步骤”（按类/函数拆解）。
- `3` 章必须给出数据结构或协议片段（JSON/类型映射/状态机）。
- `6.1` 需覆盖边界与异常路径（类型错误、流式半包、超时、早退）。
- 单元测试至少覆盖：序列化/反序列化对称性、非法输入、资源释放、错误码稳定性。
- 推荐保留“依赖关系”章节（可放 `8` 后附录）。

## 3.2 JS 运行时绑定与 Service 引擎（典型：M21-M33, M41-M48）

- 在 `2` 章前或 `3` 章前增加：
  - `设计原则（强约束）`
  - `范围与非目标`
- 必须写清 API 签名、参数校验、错误语义、生命周期清理。
- 异步能力必须明确 Promise 何时 resolve/reject、资源何时释放。
- `6.1` 需覆盖并发、异常、资源泄漏与兼容行为。
- 单元测试至少覆盖：参数校验分支、Promise 成败路径、回调顺序、重复释放幂等。

## 3.3 Server/API 与编排层（典型：M34-M58）

- `3` 章必须包含 API 契约：
  - 路径、方法、请求体、响应体、状态码、错误码。
- 写明与既有接口的兼容关系（不破坏已发布行为）。
- 涉及路由时写清静态/动态路由优先级与注册顺序。
- 涉及文件系统时写明安全约束（路径穿越、原子写入、权限边界）。
- 单元测试至少覆盖：handler 正常/异常分支、参数缺失、状态码与错误体一致性、权限/路径安全。

## 3.4 WebUI 前端模块（典型：M59-M69）

- `3` 章必须覆盖页面结构、状态管理、交互流、依赖 API 映射。
- `4` 章建议按“页面/组件/Store/Hook”分块描述。
- `6.1` 至少包含组件测试 + Store 测试；关键流程补 E2E。
- 单元测试至少覆盖：Store 状态迁移、组件关键交互、错误态渲染、API mock 分支。
- `UI/UX 设计师建议` 为可选章节，仅在视觉系统或复杂交互变更时启用。

## 3.5 发布、迁移、E2E（典型：M32, M39, M69）

- `2` 章必须写“发布/迁移边界”和“非目标”。
- `4` 章必须包含流水线或脚本步骤（构建、产物校验、发布）。
- `6.1` 必须覆盖“可复现验证”与“失败回滚”。
- 测试用例需覆盖“脚本失败退出码 + 关键产物校验 + 回滚路径”。

## 3.6 问题修复类里程碑（TDD 强制）

- 里程碑标题或目标中含"修复/fix/bugfix/回归/regression"时，**必须**采用 TDD 流程。
- `4` 章必须使用"TDD Red-Green-Refactor"三段式结构，不得使用通用实现步骤格式。
- `4.1 Red` 阶段要求：
  - 为每个待修复缺陷编写至少一条精确的失败测试，测试必须在修复前运行并确认失败。
  - 失败测试必须断言**正确行为**（而非断言"当前的错误行为"），确保修复后测试自然通过。
  - 若缺陷涉及多个触发路径，每条路径各写一条独立测试。
- `4.2 Green` 阶段要求：
  - 仅做使失败测试通过的最小改动，禁止搭车重构或附加功能。
  - 修复后必须运行完整测试套件，确认无回归。
- `4.3 Refactor` 阶段要求：
  - 可选；仅在修复引入重复代码或破坏既有结构时执行。
  - 重构后全量测试必须仍然通过。
- `6.1` 中的回归测试用例必须标注来源缺陷编号或现象描述，便于追溯。
- DoD 额外条件：失败测试在修复前确认为 Red，修复后确认为 Green，有执行记录可查。

## 4. 模板选型路线（新需求开发）

1. 仅核心库能力变更：用“C++ 核心模板”。
2. 以 JS 内置模块/绑定为主：用“JS 绑定模板”。
3. 以 HTTP/API/编排为主：用“Server/API 模板”。
4. 以页面交互为主：用“WebUI 模板”。
5. 跨栈里程碑：主模板不变，但在 `1` 章先给"子系统交付矩阵"（前端/后端/脚本/测试）。
6. 问题修复/缺陷回归：请改用 `doc/milestone_plan_template_bugfix.md`（该路线 `4` 章强制使用 Red-Green-Refactor 三段式）。

## 5. 质量闸门（提交前自检）

- [ ] 章节编号唯一、递增、无重复（历史文档已出现重复 `6/7` 编号问题）。
- [ ] 存在“前置条件 + 目标 + 范围/非目标”。
- [ ] 存在“文件变更清单 + 测试与验收 + DoD”。
- [ ] 验收标准均可客观判定，避免“体验更好”这类不可验描述。
- [ ] 风险章节包含“风险 + 控制”，不是只列风险名词。
- [ ] 术语、字段名、API 名称与现有代码和文档一致。
- [ ] 单元测试用例按“正常/边界/异常/回归”四类明确列出，不少于核心变更点数量。
- [ ] 每个新增/修改公共 API 都有对应测试，且写明测试文件路径。
- [ ] 失败场景断言包含错误码或错误类型，不只断言“失败了”。
- [ ] 所有可达测试路径均被单元测试覆盖；每条路径可追溯到具体测试用例 ID。
- [ ] 对声明"不可达"的路径提供设计级证明（状态机约束/参数前置条件/防御式分支）。
- [ ] 【问题修复类】`4` 章使用 TDD Red-Green-Refactor 三段式，非通用实现步骤格式。
- [ ] 【问题修复类】每个缺陷至少有一条失败测试，且标注了缺陷来源（编号/现象）。
- [ ] 【问题修复类】文档中记录了 Red 阶段测试确认失败、Green 阶段测试确认通过的执行证据。

## 6. 测试写作细则（重点：单元测试）

- 按“测试对象 -> 输入 -> 预期输出 -> 关键断言”四段写每类用例，避免只写标题。
- 单元测试优先验证纯逻辑与边界；集成测试只覆盖跨模块协作与契约稳定性。
- 对异步逻辑必须给出“完成条件”和“超时/取消条件”的断言方式。
- 对异常路径必须断言具体错误语义（错误码、错误消息、异常类型三选二）。
- 对回归 bug 必须附“最小复现用例”并在文档中标注来源（问题单/现象描述）。
- 对 mock 使用要说明替代边界，避免把被测逻辑也 mock 掉。
- 测试章节禁止只写“补充单元测试”，必须列出至少 3 条可执行测试场景。
- 推荐在文档中维护"决策点 -> 路径 -> 用例 ID"映射表，评审时逐条勾验，不允许遗漏路径。
- 【TDD 专项】问题修复类测试必须先于修复代码编写；测试用例断言的是"正确行为"而非"当前错误行为"。
- 【TDD 专项】失败测试（Red）必须附运行输出摘要或截图，证明修复前确实失败。
- 【TDD 专项】禁止在 Green 阶段引入与修复无关的改动；额外改进必须放到 Refactor 阶段并单独说明。

## 7. 写作约束（简洁但不漏重点）

- 目标章节控制在 `3-8` 条交付项。
- 技术要点聚焦“决策与约束”，不堆实现细节。
- 实现章节聚焦“改哪里、为什么、怎么验收”，避免逐行代码解释。
- 示例以最小可用片段为主，避免超长代码块。
- 文件清单按“新增/修改/测试”三段固定输出，便于评审和执行。
